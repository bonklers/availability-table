<script>
const SUPABASE_URL = "https://thfrvjwkqesmisyzhfji.supabase.co";
const SUPABASE_KEY = "YOUR_KEY_HERE";

const rows = 7, cols = 4;
let showShort = false;   // FALSE = >10 min, TRUE = <10 min

async function api(endpoint){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
    headers:{
      apikey: SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`
    }
  });
  return await res.json();
}

function buildGrid(){
  const table=document.getElementById("grid");
  table.innerHTML="";
  let id=1;

  for(let r=0;r<rows;r++){
    let tr=document.createElement("tr");
    for(let c=0;c<cols;c++){
      let td=document.createElement("td");
      td.innerHTML = `<div>${id}</div><div id="c${id}">0</div>`;
      tr.appendChild(td);
      id++;
    }
    table.appendChild(tr);
  }
}

function toggleFilter(){
  showShort = !showShort;
  document.getElementById("toggleBtn").innerText = showShort ? "> 10 min" : "< 10 min";
  queryData();
}

function getDayBounds(date){
  const start=new Date(date);
  start.setHours(0,0,0,0);
  const end=new Date(start);
  end.setDate(end.getDate()+1);

  return {
    from:start.toISOString(),
    to:end.toISOString()
  }
}

async function queryData(){
  const date=document.getElementById("datePicker").value;
  const bounds=getDayBounds(date);

  // âœ… CORRECT FILTER
  const operator = showShort ? "lt" : "gte";     
  const seconds = 600;

  const rows = await api(
    `cell_logs?select=cell_id,duration_seconds&color=eq.red` +
    `&start_time=gte.${bounds.from}` +
    `&start_time=lt.${bounds.to}` +
    `&duration_seconds=${operator}.${seconds}`
  );

  const counts={};
  for(let i=1;i<=28;i++) counts[i]=0;

  rows.forEach(r => counts[r.cell_id]++);

  for(let i=1;i<=28;i++){
    document.getElementById("c"+i).innerText = counts[i];
  }
}

function init(){
  buildGrid();
  const today=new Date().toISOString().split("T")[0];
  const picker=document.getElementById("datePicker");
  picker.value=today;
  picker.onchange=queryData;
  queryData();
}

init();
</script>