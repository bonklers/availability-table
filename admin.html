<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin</title>
<style>
body { text-align:center; font-family: Arial; }
table { margin:auto; border-collapse: collapse; }
td {
  width:80px;
  height:80px;
  border:1px solid black;
  font-weight:bold;
  vertical-align:middle;
}
button, input {
  margin:10px;
  padding:8px;
  font-size:14px;
}
</style>
</head>
<body>

<h2 id="title">Red cells ≥ 10 minutes</h2>

<input type="date" id="datePicker">
<button id="toggleBtn">Show < 10 minutes</button>

<table id="grid"></table>

<script src="shared.js"></script>
<script>

let showShort = false;

/* ======================== */
/* BUILD GRID */
/* ======================== */
buildGrid("grid", false);

/* ======================== */
function toggleFilter(){

  showShort = !showShort;

  toggleBtn.innerText = showShort
    ? "Show ≥ 10 minutes"
    : "Show < 10 minutes";

  title.innerText = showShort
    ? "Red < 10 minutes"
    : "Red ≥ 10 minutes";

  queryData();
}

/* ======================== */
function getDayBounds(dateStr){
  return {
    from: `${dateStr}T00:00:00.000Z`,
    to: `${dateStr}T23:59:59.999Z`
  };
}

/* ======================== */
async function queryData(){

  const date = datePicker.value;
  if(!date) return;

  const {from,to} = getDayBounds(date);
  const filter = showShort ? "lt.600" : "gte.600";

  const rows = await api(
    `cell_logs?select=cell_id,duration_seconds`+
    `&color=eq.red` +
    `&start_time=gte.${from}` +
    `&start_time=lte.${to}` +
    `&duration_seconds=${filter}`
  );

  const count = {};
  for(let i=1;i<=28;i++) count[i]=0;

  rows.forEach(r => {
    if(count[r.cell_id] !== undefined)
      count[r.cell_id]++;
  });

  for(let i=1;i<=28;i++){
    const el = document.getElementById("c"+i);
    if(el) el.innerText = count[i];
  }
}

/* ======================== */
function init(){

  // attach handlers safely
  toggleBtn.addEventListener("click", toggleFilter);
  datePicker.addEventListener("change", queryData);

  datePicker.value = new Date().toISOString().split("T")[0];
  queryData();
}

init();

</script>
</body>
</html>