<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard v0.03</title>
  <style>
    body { text-align:center; font-family: Arial; }
    table { margin:auto; border-collapse: collapse; }
    td {
      width: 80px;
      height: 80px;
      border: 1px solid black;
      font-weight: bold;
      vertical-align: middle;
    }
    button, input {
      margin: 10px;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Admin Dashboard</h2>

<input type="date" id="datePicker">

<button id="toggleBtn" onclick="toggleFilter()">&lt; 10 min</button>

<table id="grid"></table>

<script>
/* ===================== */
/* SUPABASE SETTINGS */
/* ===================== */
const SUPABASE_URL = "https://thfrvjwkqesmisyzhfji.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoZnJ2andrcWVzbWlzeXpoZmppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNzA2MjksImV4cCI6MjA3OTk0NjYyOX0.lid5S9n4OX2O7IjkO5JFIPBT9mXSIuEMyqt1SCCBECg";

/* ===================== */
const rows = 7, cols = 4;
let showShort = true;   // true = <10 min, false = >10 min

/* ===================== */
async function api(endpoint){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
    headers:{
      apikey: SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`
    }
  });
  return await res.json();
}

/* ===================== */
function buildGrid(){
  const table=document.getElementById("grid");
  table.innerHTML="";
  let id=1;

  for(let r=0;r<rows;r++){
    let tr=document.createElement("tr");
    for(let c=0;c<cols;c++){
      let td=document.createElement("td");
      td.innerHTML = `<div>${id}</div><div id="c${id}">0</div>`;
      tr.appendChild(td);
      id++;
    }
    table.appendChild(tr);
  }
}

/* ===================== */
function toggleFilter(){
  showShort = !showShort;
  document.getElementById("toggleBtn").innerText = showShort ? "< 10 min" : "> 10 min";
  queryData();
}

/* ===================== */
function getDayBounds(date){
  const start = new Date(date);
  start.setHours(0,0,0,0);

  const end = new Date(start);
  end.setDate(end.getDate()+1);

  return { from:start.toISOString(), to:end.toISOString() };
}

/* ===================== */
async function queryData(){

  const date = document.getElementById("datePicker").value;
  if (!date) return;

  const bounds = getDayBounds(date);

  // âœ… Correct filter
  const durationFilter = showShort ? "lt.600" : "gte.600";

  const rows = await api(
    `cell_logs?select=cell_id,duration_seconds&color=eq.red` +
    `&start_time=gte.${bounds.from}` +
    `&start_time=lt.${bounds.to}` +
    `&duration_seconds=${durationFilter}`
  );

  const counts = {};
  for(let i=1;i<=28;i++) counts[i] = 0;

  rows.forEach(r => {
    counts[r.cell_id]++;
  });

  for(let i=1;i<=28;i++){
    document.getElementById("c"+i).innerText = counts[i];
  }
}

/* ===================== */
function init(){
  buildGrid();
  const today = new Date().toISOString().split("T")[0];
  const picker = document.getElementById("datePicker");
  picker.value = today;
  picker.onchange = queryData;
  queryData();
}

init();
</script>

</body>
</html>