<!DOCTYPE html>
<html>
<head>
<title>Tracker v0.06</title>
<style>
body { text-align:center; font-family: Arial; }
table { border-collapse: collapse; margin:auto; }
td {
  width: 70px; height: 70px;
  border: 1px solid black;
  cursor: pointer;
  font-weight: bold;
}
.desc { display:none; font-size:11px; }
button { margin:10px; padding:8px; }
</style>
</head>
<body>

<button onclick="toggleLegend()">Legend</button>
<table id="grid"></table>

<script src="shared.js"></script>
<script>

let showLegend = false;
let lastLogs = {};
let startTimes = {};

function toggleLegend(){
  showLegend=!showLegend;
  document.querySelectorAll(".desc").forEach(d=> {
    d.style.display = showLegend ? "block" : "none";
  });
}

function buildGrid(){
  const table = document.getElementById("grid");
  table.innerHTML = "";
  let id = 1;

  for(let r=0;r<GRID_ROWS;r++){
    const tr = document.createElement("tr");
    for(let c=0;c<GRID_COLS;c++){
      if(id > TOTAL_CELLS) break;
      const td = document.createElement("td");
      td.dataset.id = id;
      td.innerHTML = `<div>${id}</div><div class="desc">${LEGEND_TEXT[id]}</div>`;
      td.onclick = ()=> changeCell(id);
      tr.appendChild(td);
      id++;
    }
    table.appendChild(tr);
  }
}

async function loadState(){
  const cells = document.querySelectorAll("td");
  const rows = await api("cell_logs?select=cell_id,color,start_time,id&order=start_time.desc");

  cells.forEach(c => c.style.backgroundColor = "green");
  lastLogs = {}; startTimes = {};
  const found = {};

  rows.forEach(row=>{
    const i = row.cell_id - 1;
    if(!found[row.cell_id] && cells[i]){
      cells[i].style.backgroundColor = row.color;
      lastLogs[row.cell_id] = row.id;
      startTimes[row.cell_id] = safeUtc(row.start_time.replace(" ","T"));
      found[row.cell_id] = true;
    }
  });
}

async function changeCell(cellId){
  const cells = document.querySelectorAll("td");
  const cell = cells[cellId - 1];
  const current = cell.style.backgroundColor || "green";
  const newColor = nextColor(current);
  const now = new Date().toISOString();

  if(lastLogs[cellId]){
    const since = new Date(startTimes[cellId]);
    const seconds = Math.max(0, Math.floor((Date.now() - since.getTime()) / 1000));
    await api(`cell_logs?id=eq.${lastLogs[cellId]}`, "PATCH", { duration_seconds: seconds });
  }

  const newRow = await api("cell_logs", "POST", {
    cell_id: cellId,
    color: newColor,
    start_time: now
  });

  lastLogs[cellId] = newRow[0].id;
  startTimes[cellId] = now;
  cell.style.backgroundColor = newColor;
}

buildGrid();
loadState();
</script>

</body>
</html>