<!DOCTYPE html>
<html>
<head>
  <title>Cell Tracker</title>
  <style>
    body { text-align:center; font-family: Arial; }
    table { border-collapse: collapse; margin:auto; }
    td {
      width: 70px;
      height: 70px;
      border: 1px solid black;
      cursor: pointer;
      vertical-align: middle;
      font-weight: bold;
    }
    .desc { display:none; font-size:11px; }
    button { margin:10px; padding:8px; }
  </style>
</head>
<body>
v1.0
<button onclick="toggleLegend()">Legend</button>
<table id="grid"></table>

<script>
/* ========================== */
/* SUPABASE CONFIG */
/* ========================== */
const SUPABASE_URL = "https://thfrvjwkqesmisyzhfji.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoZnJ2andrcWVzbWlzeXpoZmppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNzA2MjksImV4cCI6MjA3OTk0NjYyOX0.lid5S9n4OX2O7IjkO5JFIPBT9mXSIuEMyqt1SCCBECg";

/* ========================== */
const rows = 7, cols = 4;
const colors = ["green", "red", "yellow"];
const legendText = {
  1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven",
  8:"eight",9:"nine",10:"ten",11:"eleven",12:"twelve",13:"thirteen",
  14:"fourteen",15:"fifteen",16:"sixteen",17:"seventeen",18:"eighteen",
  19:"nineteen",20:"twenty",21:"twenty-one",22:"twenty-two",
  23:"twenty-three",24:"twenty-four",25:"twenty-five",
  26:"twenty-six",27:"twenty-seven",28:"twenty-eight"
};

let showLegend=false;
let lastLogs={};

/* ========================== */
async function api(endpoint,method="GET",body=null){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`,{
    method,
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`,
      "Content-Type":"application/json",
      Prefer:"return=representation"
    },
    body: body?JSON.stringify(body):null
  });
  return await res.json();
}

/* ========================== */
function toggleLegend(){
  showLegend=!showLegend;
  document.querySelectorAll(".desc").forEach(d=>d.style.display=showLegend?"block":"none");
}

/* ========================== */
function nextColor(color){
  return colors[(colors.indexOf(color)+1)%colors.length];
}

/* ========================== */
function buildGrid(){
  let table=document.getElementById("grid");
  let id=1;

  for(let r=0;r<rows;r++){
    let tr=document.createElement("tr");
    for(let c=0;c<cols;c++){
      let td=document.createElement("td");

      let num=document.createElement("div");
      num.innerText=id;

      let desc=document.createElement("div");
      desc.className="desc";
      desc.innerText=legendText[id];

      td.appendChild(num);
      td.appendChild(desc);
      td.dataset.id=id;

      td.onclick=()=>changeCell(id);
      tr.appendChild(td);
      id++;
    }
    table.appendChild(tr);
  }
}

/* ========================== */
/* LOAD FROM DATABASE */
/* ========================== */
async function loadState(){
  const rows = await api("cell_logs?select=cell_id,color,start_time,id&order=start_time.desc");
  const found={};

  document.querySelectorAll("td").forEach(td=>{
    td.style.backgroundColor="green";
  });

  rows.forEach(row=>{
    if(!found[row.cell_id]){
      const cell=document.querySelectorAll("td")[row.cell_id-1];
      cell.style.backgroundColor=row.color;
      cell.dataset.start=row.start_time;
      lastLogs[row.cell_id]=row.id;
      found[row.cell_id]=true;
    }
  });
}

/* ========================== */
/* CHANGE CELL */
/* ========================== */
async function changeCell(cellId){
  const cell=document.querySelectorAll("td")[cellId-1];
  const current = cell.style.backgroundColor || "green";
  const newColor = nextColor(current);
  const now=new Date().toISOString();

  /* CLOSE PREVIOUS RECORD */
  if(lastLogs[cellId]){
    const since = new Date(cell.dataset.start);
    const seconds = Math.floor((Date.now()-since)/1000);

    await api(`cell_logs?id=eq.${lastLogs[cellId]}`,"PATCH",{
      duration_seconds:seconds
    });
  }

  /* INSERT NEW STATE */
  await api("cell_logs","POST",{
    cell_id:cellId,
    color:newColor,
    start_time:now
  });

  /* RELOAD CONFIRMED STATE FROM DB */
  await loadState();
}

/* ========================== */
buildGrid();
loadState();
</script>

</body>
</html>