<!DOCTYPE html>
<html>
<head>
  <title>Tracker v0.05</title>
  <style>
    body { text-align:center; font-family: Arial; }
    table { border-collapse: collapse; margin:auto; }
    td {
      width: 70px;
      height: 70px;
      border: 1px solid black;
      cursor: pointer;
      vertical-align: middle;
      font-weight: bold;
    }
    .desc { display:none; font-size:11px; }
    button { margin:10px; padding:8px; }
  </style>
</head>
<body>

<button onclick="toggleLegend()">Legend</button>
<table id="grid"></table>

<script>
/* ========================== */
/* SUPABASE CONFIG */
/* ========================== */
const SUPABASE_URL = "https://thfrvjwkqesmisyzhfji.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoZnJ2andrcWVzbWlzeXpoZmppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNzA2MjksImV4cCI6MjA3OTk0NjYyOX0.lid5S9n4OX2O7IjkO5JFIPBT9mXSIuEMyqt1SCCBECg";

/* ========================== */
const rows = 7, cols = 4;
const colors = ["green", "red", "yellow"];
const legendText = {
  1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven",
  8:"eight",9:"nine",10:"ten",11:"eleven",12:"twelve",13:"thirteen",
  14:"fourteen",15:"fifteen",16:"sixteen",17:"seventeen",18:"eighteen",
  19:"nineteen",20:"twenty",21:"twenty-one",22:"twenty-two",
  23:"twenty-three",24:"twenty-four",25:"twenty-five",
  26:"twenty-six",27:"twenty-seven",28:"twenty-eight"
};

let showLegend=false;
let lastLogs={};
let startTimes={};  

/* ========================== */
async function api(endpoint,method="GET",body=null){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`,{
    method,
    headers:{
      apikey:SUPABASE_KEY,
      Authorization:`Bearer ${SUPABASE_KEY}`,
      "Content-Type":"application/json",
      Prefer:"return=representation"
    },
    body: body?JSON.stringify(body):null
  });
  return await res.json();
}

/* ========================== */
function toggleLegend(){
  showLegend=!showLegend;
  document.querySelectorAll(".desc").forEach(d=>d.style.display=showLegend?"block":"none");
}

/* ========================== */
function nextColor(color){
  return colors[(colors.indexOf(color)+1)%colors.length];
}

/* ========================== */
function buildGrid() {

  const table = document.getElementById("grid");
  table.innerHTML = "";

  let id = 1;

  for (let r = 0; r < 7; r++) {
    const tr = document.createElement("tr");

    for (let c = 0; c < 4; c++) {

      if (id > 28) break;

      const td = document.createElement("td");
      td.dataset.id = id;

      const num = document.createElement("div");
      num.innerText = id;

      const desc = document.createElement("div");
      desc.className = "desc";
      desc.innerText = legendText[id] || "";

      td.appendChild(num);
      td.appendChild(desc);

      const cellId = id;
      td.onclick = () => changeCell(cellId);

      tr.appendChild(td);
      id++;
    }

    table.appendChild(tr);
  }

}

/* ========================== */
/* LOAD FROM DATABASE */
/* ========================== */
async function loadState() {

  const cells = document.querySelectorAll("td");
  const rows = await api("cell_logs?select=cell_id,color,start_time,id&order=start_time.desc");

  const found = {};
  
  cells.forEach(cell => cell.style.backgroundColor = "green");

  lastLogs = {};
  startTimes = {};

  rows.forEach(row => {
    const index = row.cell_id - 1;

    if (!found[row.cell_id] && cells[index]) {
      cells[index].style.backgroundColor = row.color;
      lastLogs[row.cell_id] = row.id;

      // ✅ Enforce safe ISO UTC time formatting
      startTimes[row.cell_id] = row.start_time.replace(" ", "T") + "Z";

      found[row.cell_id] = true;
    }
  });
}

/* ========================== */
/* CHANGE CELL */
/* ========================== */
async function changeCell(cellId) {

  const cells = document.querySelectorAll("td");

  const cell = cells[cellId - 1];
  if (!cell) return console.error("CELL MISSING:", cellId);

  const current = cell.style.backgroundColor || "green";
  const newColor = nextColor(current);
  const now = new Date().toISOString();

  /* CLOSE PREVIOUS STATE */
  if (lastLogs[cellId]) {

    if (!startTimes[cellId]) {
      console.warn("Missing start time for", cellId);
      return;
    }

    // ✅ Force UTC parse
    const since = new Date(startTimes[cellId] + "Z");

    // ✅ Hard safety
    if (isNaN(since.getTime())) {
      console.error("Invalid timestamp:", startTimes[cellId]);
      return;
    }

    const seconds = Math.max(0, Math.floor((Date.now() - since.getTime()) / 1000));

    console.log("Closing:", cellId, "Duration:", seconds);

    await api(`cell_logs?id=eq.${lastLogs[cellId]}`, "PATCH", {
      duration_seconds: seconds
    });
  }

  /* OPEN NEW STATE */
  const newRow = await api("cell_logs", "POST", {
    cell_id: cellId,
    color: newColor,
    start_time: now
  });

  /* SAVE IMMEDIATELY */
  lastLogs[cellId] = newRow[0].id;
  startTimes[cellId] = now;

  cell.style.backgroundColor = newColor;
}

/* ========================== */
buildGrid();
loadState();
</script>

</body>
</html>