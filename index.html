<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tracker v0.07</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; text-align:center; }
table { margin:auto; border-collapse: collapse; }
td {
  width:90px;
  height:80px;
  border:1px solid black;
  text-align:center;
  vertical-align:middle;
}
.desc { font-size:12px; }
.green { background:#9aff9a; }
.red { background:#ff9a9a; }
.yellow { background:#ffff9a; }
</style>
</head>

<body>
<h2>Daily Tracker</h2>

<table id="grid"></table>

<script src="shared.js"></script>
<script>

const today = new Date().toISOString().slice(0,10);

function getIdCellMap(){
  return [...document.querySelectorAll("#grid td")]
         .reduce((m,td)=> (m[td.dataset.id]=td,m),{});
}

/* ========================== */
/* CHANGE CELL COLOR */
/* ========================== */
async function changeCell(cellId){

  const map = getIdCellMap();
  const cell = map[cellId];
  if(!cell){
    console.error("Invalid cell:", cellId);
    return;
  }

  const current = cell.dataset.color || "green";
  const next = nextColor(current);

  cell.dataset.color = next;
  cell.className = next;

  const rec = {
    cell_id: cellId,
    color: next,
    changed_at: new Date().toISOString()
  };

  await api("tracker", "POST", rec);
}


/* ========================== */
/* LOAD CURRENT DAY DATA */
/* ========================== */
async function loadState(){

  const {from,to} = getDayBounds(today);
  const data = await api(`tracker?changed_at=gte.${from}&changed_at=lte.${to}&order=changed_at.asc`);

  const map = getIdCellMap();

  data.forEach(r=>{
    const cell = map[r.cell_id];
    if(cell){
      cell.dataset.color = r.color;
      cell.className = r.color;
    }
  });
}


/* ========================== */
/* INIT */
/* ========================== */
buildGrid("grid", true);
loadState();

</script>
</body>
</html>