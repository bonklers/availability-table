<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Resumen</title>
<style>
body { text-align:center; font-family: Arial; }
table { margin:auto; border-collapse: collapse; }
td {
  width:80px;
  height:80px;
  border:1px solid black;
  font-weight:bold;
  vertical-align:middle;
}
button, input {
  margin:10px;
  padding:8px;
  font-size:14px;
}
</style>
</head>
<body>

<h2 id="title"></h2>

<input type="date" id="datePicker">
<button id="toggleBtn">Mostrar menos de 10 minutos</button>

<table id="grid"></table>

<script src="shared.js"></script>
<script>

let showShort = false;

/* ======================== */
/* BUILD GRID */
/* ======================== */
buildGrid("grid", false, "admin");

/* ======================== */

function setTitle(total = 0){

  if (showShort) {
    title.innerHTML = `Ocupados <span style="color:red">menos</span> de 10 minutos TOTAL ${total}`;
  }
  else {
    title.innerHTML = `Ocupados mas de 10 minutos TOTAL ${total}`;
  }
}

function toggleFilter(){

  showShort = !showShort;

  toggleBtn.innerText = showShort
    ? "Mostrar mas de 10 minutos"
    : "Mostrar menos de 10 minutos";

  setTitle();
  queryData();
}

/* ======================== */
async function queryData(){

  const date = datePicker.value;
  if(!date) return;

  const {from,to} = getDayBounds(date);
  const filter = showShort ? "lt.600" : "gte.600";

  const rows = await api(
    `cell_logs?select=cell_id,duration_seconds`+
    `&color=eq.red` +
    `&end_time=gte.${from}` +
    `&end_time=lte.${to}` +
    `&duration_seconds=${filter}`
  );

  const count = {};
  for(let i=1;i<=28;i++) count[i]=0;

  rows.forEach(r => {
    if(count[r.cell_id] !== undefined)
      count[r.cell_id]++;
  });

  let total = 0;

  for(let i=1;i<=28;i++){
    const el = document.getElementById("c"+i);
    if(el){
      el.innerText = count[i];
      total += count[i];
    }
  }

  setTitle(total);
}

/* ======================== */
function init(){

  // attach handlers safely
  toggleBtn.addEventListener("click", toggleFilter);
  datePicker.addEventListener("change", queryData);

  datePicker.value = getLocalDate();
  setTitle(0);
  queryData();
}

function getLocalDate() {
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  return now.toISOString().split("T")[0];
}

init();
setInterval(queryData, 5000);
</script>
</body>
</html>