<!DOCTYPE html>
<html>
<head>
<title>Viewer v0.02</title>
<style>
body { text-align:center; font-family: Arial; }
table { margin:auto; border-collapse: collapse; }
td {
  width: 70px;
  height: 70px;
  border: 1px solid black;
  font-weight:bold;
}
.desc { display:none; font-size:11px; }
button { margin:10px; padding:8px; }
</style>
</head>
<body>

<button onclick="toggleLegend()">Legend</button>
<table id="grid"></table>

<script src="shared.js"></script>
<script>

let showLegend=false;

function toggleLegend(){
  showLegend = !showLegend;
  document.querySelectorAll(".desc").forEach(d=>{
    d.style.display = showLegend ? "block" : "none";
  });
}

function buildGrid(){
  const table = document.getElementById("grid");
  table.innerHTML="";
  let id=1;

  for(let r=0;r<GRID_ROWS;r++){
    let tr=document.createElement("tr");
    for(let c=0;c<GRID_COLS;c++){
      if(id > TOTAL_CELLS) break;
      let td=document.createElement("td");
      td.innerHTML=`<div>${id}</div><div class="desc">${LEGEND_TEXT[id]}</div>`;
      td.dataset.id=id;
      tr.appendChild(td);
      id++;
    }
    table.appendChild(tr);
  }
}

async function loadState(){
  const rows = await api("cell_logs?select=cell_id,color,start_time&order=start_time.desc");
  const cells = document.querySelectorAll("td");
  cells.forEach(c=>c.style.backgroundColor="green");
  let found={};

  rows.forEach(r=>{
    const idx=r.cell_id-1;
    if(!found[r.cell_id] && cells[idx]){
      cells[idx].style.backgroundColor=r.color;
      found[r.cell_id]=true;
    }
  });
}

buildGrid();
loadState();
setInterval(loadState, 5000);
</script>

</body>
</html>